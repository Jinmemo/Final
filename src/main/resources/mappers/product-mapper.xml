<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="productMapper">

	<resultMap type="product" id="productResultSet" autoMapping="true">
		<id column="PROD_NO" property="prodNo" />
		<collection property="detail" javaType="list" ofType="prodDetail"
			select="selectProdDetailList" column="PROD_NO" />
		<collection property="image" javaType="list" ofType="image"
			select="selectProdImageList" column="PROD_NO" />
	</resultMap>
	

	<select id="selectProductList" parameterType="map" resultMap="productResultSet">
		SELECT PROD_NO, PROD_NAME, PROD_CAP, PRICE, DISCOUNT_RATE, CATE_SUB, ORDERED, THICKNESS, LINING, SEE_THROUGH, FABRIC, PATTERN, LINE, SEASON, UPLOAD_DATE, STATUS
		FROM PRODUCT
		LEFT JOIN CATE_SUB USING (CATE_SUB)
		<where>
			<if test='cateMain != null'>AND CATE_MAIN IN (#{cateMain})</if>
			<if test='cateSub != null'>AND CATE_SUB IN (#{cateSub})</if>
		</where>
	</select>
	<select id="getProductById" parameterType="int" resultType="product">
        SELECT *
        FROM PRODUCT
        WHERE PROD_NO = 1
	</select>

	<select id="selectProdDetailList" parameterType="int" resultType="prodDetail">
		SELECT "INDEX", PROD_NO, "SIZE", STACK, TOP, BOTTOM, COLOR_NO, COLOR_NAME, RGB 
		FROM PROD_DETAIL
		LEFT JOIN PALETTE USING (COLOR_NO)
		WHERE PROD_NO = #{prodNo} AND STACK > 0
		ORDER BY "INDEX", "SIZE" DESC
	</select>

	<select id="selectProdImageList" parameterType="int" resultType="image">
		SELECT IMG_NO, REF_NO, COLOR_NO, IMG_TYPE, IMG_NAME, COLOR_NAME, RGB
		FROM IMAGE
		LEFT JOIN PALETTE USING (COLOR_NO)
		WHERE REF_NO = #{refNo}
	</select>
	
	<select id="selectCartList" resultMap="productResultSet">
		SELECT P.PROD_NO, P.PROD_NAME, P.PROD_CAP, P.PRICE, P.DISCOUNT_RATE, P.CATE_SUB, P.ORDERED, P.THICKNESS, P.LINING, P.SEE_THROUGH, P.FABRIC, P.PATTERN, P.LINE, P.SEASON, P.UPLOAD_DATE, P.STATUS
		FROM PRODUCT P
		JOIN PROD_DETAIL D ON P.PROD_NO = D.PROD_NO
		WHERE P.PROD_NO IN
	    <foreach item="item" index="index" collection="list" open="(" separator="," close=")">
	        #{item}
	    </foreach>
	</select>

	<select id="selectReviewList" parameterType="int" resultType="review">
		SELECT REVIEW_NO, PROD_NO, MEMBER_NO, MEMBER_NAME, REVIEW_CONTENT, R.CREATE_DATE, RATING, HEIGHT, WEIGHT, TOP, BOTTOM, ISTRUETOSIZE
		FROM REVIEW R
		LEFT JOIN MEMBER USING (MEMBER_NO)
		WHERE R.STATUS = 'Y' AND PROD_NO = #{prodNo}
	</select>

	<select id="selectProdName" parameterType="int" resultType="product">
		SELECT PROD_NO, PROD_NAME, PRICE, DISCOUNT_RATE
		  FROM PRODUCT
		 WHERE PROD_NO = #{prodNo}
	</select>
	
<!-- 상품 등록시 쓸 예정, 지우지 말 것 -->
	<select id = "searchByCate" resultMap = "productResultSet">
		
		SELECT PROD_NO, PROD_NAME, PROD_CAP, PRICE, DISCOUNT_RATE, CATE_SUB, ORDERED, THICKNESS, LINING, SEE_THROUGH, FABRIC, PATTERN, LINE, SEASON, UPLOAD_DATE, STATUS
		FROM PRODUCT
		LEFT JOIN CATE_SUB USING (CATE_SUB)
		LEFT JOIN PROD_DETAIL USING (PROD_NO)
		
		<where>
			<if test='colorNo != "NULL"'>OR COLOR_NO = #{colorNo}</if>
			<if test='size != "NULL"'>OR SIZE = #{size}</if>
			<if test='fabric != "NULL"'>OR FABRIC = #{fabric}</if>
			<if test='lining != "NULL"'>OR FABRIC = #{lining}</if>
			<if test='seeThrough != "NULL"'>OR SEE_THROUGH = #{seeThrough}</if>
			<if test='thickness != "NULL"'>THICKNESS = #{thickness}</if>
		</where>
		
	</select>
	 
	<select id="reviewerCheck" parameterType="hashMap" resultType="int">
		SELECT COUNT(*) FROM ORDER_PROD
		LEFT JOIN "ORDER" USING(ORDER_NO)
		WHERE PROD_NO = #{prodNo} AND MEMBER_NO = #{memberNo}
	</select>
	
	<select id="selectColors" resultType="palette">
		SELECT COLOR_NO, COLOR_NAME, RGB
		FROM PALETTE
	</select>
	
	<insert id="insertReview" parameterType="review">
		INSERT INTO REVIEW(REVIEW_NO, PROD_NO, MEMBER_NO, REVIEW_CONTENT, RATING, HEIGHT, WEIGHT, TOP, BOTTOM, ISTRUETOSIZE)
		VALUES(SEQ_REVIEW_NO.NEXTVAL, #{prodNo}, #{memberNo}, #{reviewContent}, #{rating}, #{height}, #{weight}, #{top}, #{bottom}, #{isTrueToSize})
	</insert>
	
	<select id="selectImgByProdNo">
		 SELECT *
           FROM( SELECT *
		           FROM IMAGE
		          WHERE REF_NO=#{prodNo}
		            AND IMG_TYPE=1)
          WHERE ROWNUM=1
	</select>

	<select id = "selectCateMainList" resultType = "CategoryMain">
		SELECT CATE_MAIN, MAIN_NAME
		FROM CATE_MAIN	
	</select>
	
	<select id = "selectseeThroughList" resultType = "String">
		SELECT SEE_THROUGH
		FROM PRODUCT
		GROUP BY SEE_THROUGH
	</select>
	
	<select id = "selectColorList" resultType = "Palette">
		SELECT COLOR_NO , COLOR_NAME, RGB
		FROM PALETTE
	</select>
	
	<select id = "selectCateSubList" resultType = "CategorySub">
		SELECT CATE_SUB, SUB_NAME
		FROM CATE_SUB
	</select>
	
	<update id="updateReview" parameterType="review">
		UPDATE REVIEW
		SET REVIEW_CONTENT = #{reviewContent},
			RATING = #{rating},
			HEIGHT = #{height},
			WEIGHT = #{weight},
			TOP = #{top},
			BOTTOM = #{bottom},
			ISTRUETOSIZE = #{isTrueToSize}
		WHERE REVIEW_NO = #{reviewNo} AND MEMBER_NO = #{memberNo}
	</update>
	
	<update id="deleteReview" parameterType="int">
		UPDATE REVIEW
		SET STATUS = 'N'
		WHERE REVIEW_NO = #{reviewNo}
	</update>
	
	
	
	
	
	
	
	
	
	
	
	
	
<!-- 나중에 쓸 예정, 지우지 말 것 -->
<!-- INSERT INTO prod_detail(
    PROD_NO,
    "INDEX"
) values(
    #{???},
    (select count(*) from prod_detail WHERE prod_no = 2)
) -->


</mapper>